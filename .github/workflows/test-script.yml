name: Test Assembly Script

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm build-essential libgl1-mesa-dev

      - name: Cache objconv
        id: cache-objconv
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/objconv
          key: ${{ runner.os }}-objconv-2.50

      - name: Setup objconv
        if: steps.cache-objconv.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/gitGNU/objconv/archive/refs/tags/v2.50.tar.gz
          tar -xzf v2.50.tar.gz
          cd objconv-2.50/src
          chmod +x build.sh
          ./build.sh
          sudo cp objconv /usr/local/bin/

      - name: Create dummy C file for testing
        run: |
          echo 'int main() { return 0; }' > test.c

      - name: Run conversion script
        run: |
          chmod +x c2nasm.sh
          ./c2nasm.sh test.c

      - name: Verify output
        run: |
          if [ -f "test.c.run" ]; then
            echo "Success: Execution file created."
          else
            echo "Failure: Execution file missing."
            exit 1
          fi

